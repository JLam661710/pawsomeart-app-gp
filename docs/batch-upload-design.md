# 分批上传技术方案设计

## 1. 现状分析

### 当前上传流程
- 前端：一次性将所有文件（宠物照片 + 参考图）打包到 FormData 发送
- 后端：使用 multer/multiparty 解析，限制 20MB 文件大小，20个文件数量
- 处理：所有文件一次性上传到飞书云文档，然后创建订单记录

### 存在的问题
- 大文件或多文件上传容易超时
- 网络不稳定时整个上传失败
- 用户体验差，无法看到上传进度
- 云函数执行时间限制（需要优化处理大文件上传）

## 2. 分批上传方案设计

### 2.1 设计原则
- **向后兼容**：保持原有 `/api/submit-order` 接口不变
- **渐进增强**：新增分批上传功能，原功能作为降级方案
- **用户体验**：添加上传进度显示
- **安全稳定**：完整的错误处理和重试机制

### 2.2 技术架构

#### 前端改造
```
检测文件大小/数量 → 选择上传策略
├── 小文件/少量文件 → 使用原有一次性上传
└── 大文件/多文件 → 使用分批上传
    ├── 文件分组（每批2-3个文件或总大小<5MB）
    ├── 逐批上传到新接口 `/api/upload-batch`
    ├── 显示上传进度
    └── 所有批次完成后调用 `/api/submit-order-batch`
```

#### 后端新增接口
1. **`/api/upload-batch`** - 分批文件上传
   - 接收单批文件
   - 上传到飞书并返回文件ID
   - 支持重试机制

2. **`/api/submit-order-batch`** - 分批订单提交
   - 接收所有文件ID和订单信息
   - 创建订单记录
   - 关联已上传的文件

### 2.3 数据流设计

#### 分批上传流程
```
1. 前端文件预处理
   ├── 计算总大小和数量
   ├── 决定上传策略
   └── 文件分组

2. 分批上传阶段
   ├── 批次1 → /api/upload-batch → 返回 fileIds1
   ├── 批次2 → /api/upload-batch → 返回 fileIds2
   └── 批次N → /api/upload-batch → 返回 fileIdsN

3. 订单提交阶段
   └── 所有fileIds + 订单信息 → /api/submit-order-batch
```

#### 数据结构
```javascript
// 分批上传请求
{
  batchId: "batch_123456",
  batchIndex: 1,
  totalBatches: 3,
  files: [File1, File2, File3]
}

// 分批上传响应
{
  success: true,
  batchId: "batch_123456",
  fileIds: ["file_id_1", "file_id_2", "file_id_3"],
  uploadedCount: 3
}

// 订单提交请求
{
  batchId: "batch_123456",
  userUploads: ["file_id_1", "file_id_2", "file_id_3"],
  referenceImages: ["file_id_4"],
  orderData: { phone, email, customization_style, ... }
}
```

### 2.4 错误处理和降级机制

#### 降级策略
1. **自动降级**：分批上传失败时自动切换到原有上传方式
2. **手动降级**：用户可选择使用传统上传方式
3. **部分失败处理**：某批次失败时支持重试该批次

#### 错误处理
```javascript
// 前端错误处理
try {
  // 尝试分批上传
  await batchUpload(files);
} catch (error) {
  console.warn('分批上传失败，切换到传统上传:', error);
  // 降级到原有上传方式
  await traditionalUpload(files);
}
```

### 2.5 用户体验优化

#### 进度显示
- 整体进度：已完成批次 / 总批次
- 当前批次进度：当前批次上传进度
- 预估时间：基于已完成批次计算剩余时间

#### UI组件设计
```jsx
<UploadProgress 
  totalBatches={3}
  completedBatches={1}
  currentBatchProgress={45}
  estimatedTime="2分钟"
  canCancel={true}
  onCancel={handleCancel}
/>
```

## 3. 实施计划

### 3.1 开发阶段
1. **阶段1**：创建备份分支，确保代码安全
2. **阶段2**：实现后端分批上传接口
3. **阶段3**：实现前端分批上传逻辑
4. **阶段4**：添加进度显示UI
5. **阶段5**：实现降级机制

### 3.2 测试策略
1. **单元测试**：各个函数和组件的独立测试
2. **集成测试**：分批上传完整流程测试
3. **压力测试**：大文件、多文件场景测试
4. **兼容性测试**：确保原有功能不受影响
5. **用户体验测试**：真实场景下的用户操作测试

### 3.3 部署策略
1. **灰度发布**：先对部分用户开启分批上传
2. **监控观察**：监控成功率、性能指标
3. **逐步推广**：确认稳定后全量开启
4. **保留开关**：保留功能开关，可快速回退

## 4. 风险控制

### 4.1 技术风险
- **风险**：分批上传增加复杂度
- **控制**：完整的测试覆盖，降级机制

### 4.2 用户体验风险
- **风险**：上传时间可能增加
- **控制**：智能策略选择，进度显示

### 4.3 数据一致性风险
- **风险**：部分批次失败导致数据不完整
- **控制**：事务性处理，失败回滚机制

## 5. 成功指标

- 大文件上传成功率提升至 95% 以上
- 用户上传体验评分提升
- 原有功能保持 100% 兼容性
- 系统稳定性无下降

---

**注意**：此方案确保了最大的安全性和稳定性，通过渐进式改进和完整的降级机制，最大程度降低对现有系统的影响。