# 火山引擎veFaaS简化架构规划方案

## 项目概述

基于火山引擎函数服务(veFaaS)和API网关的技术优势，本方案旨在大幅简化PawsomeArt项目的后端架构，消除复杂的批量上传机制，减少开发和维护成本。

## 当前架构问题分析

### 现有复杂度

当前Vercel部署方案存在以下复杂性：

1. **多层上传策略**
   - 传统上传：`/api/submit-order.js`
   - 批量上传：`/api/upload-batch.js` + `/api/submit-order-batch.js`
   - 前端智能选择机制：`shouldUseBatchUpload()`

2. **文件大小限制导致的复杂逻辑**
   - 4.5MB单次请求限制
   - 文件分组算法：`groupFilesIntoBatches()`
   - 进度管理：多批次上传进度追踪
   - 错误处理：部分批次失败的回滚机制

3. **执行时间限制的应对措施**
   - 10-30秒超时限制
   - 分批处理避免超时
   - 复杂的重试和降级机制

### 技术债务

- **代码复杂度高**：批量上传逻辑占用大量开发资源
- **测试复杂度高**：需要测试多种上传策略和边界情况
- **维护成本高**：多套上传机制增加维护负担
- **用户体验复杂**：复杂的进度显示和错误处理

## 火山引擎veFaaS技术优势

### 核心优势对比

| 技术指标 | Vercel限制 | 火山引擎veFaaS | 提升倍数 |
|---------|-----------|---------------|----------|
| **单次请求大小** | 4.5MB | 无严格限制* | 10x+ |
| **执行时间** | 10-30秒 | 最长3小时 | 360-1080x |
| **并发处理** | 有限制 | 弹性扩容 | 显著提升 |
| **内存配置** | 固定 | 可配置(最高3008MB) | 灵活配置 |

*注：具体限制需通过实际测试确认

### 架构简化潜力

基于火山引擎的技术优势，可以实现：

1. **单一上传路径**：消除批量上传的必要性
2. **简化错误处理**：减少复杂的重试和降级逻辑
3. **统一API接口**：一个函数处理所有上传场景
4. **简化前端逻辑**：移除上传策略选择机制

## 简化架构设计

### 目标架构

```
用户上传 → 前端表单 → API网关 → 单一云函数 → 飞书API → 返回结果
```

### 函数服务规划

#### 核心函数：统一订单处理函数

**函数名称**：`submit-order-unified`

**功能职责**：
- 接收所有类型的订单提交请求
- 处理任意数量和大小的文件上传
- 统一的数据验证和处理逻辑
- 直接写入飞书多维表格

**技术配置**：
```javascript
{
  "functionName": "submit-order-unified",
  "runtime": "nodejs18.x",
  "memorySize": 1024, // 1GB内存
  "timeout": 300,     // 5分钟超时
  "environment": {
    "FEISHU_APP_ID": "${FEISHU_APP_ID}",
    "FEISHU_APP_SECRET": "${FEISHU_APP_SECRET}",
    "FEISHU_APP_TOKEN": "${FEISHU_APP_TOKEN}",
    "FEISHU_ORDERS_TABLE_ID": "${FEISHU_ORDERS_TABLE_ID}"
  }
}
```

#### 辅助函数：推荐服务函数

**函数名称**：`recommendations`

**功能职责**：
- 提供图片推荐服务
- 轻量级，快速响应

**技术配置**：
```javascript
{
  "functionName": "recommendations",
  "runtime": "nodejs18.x",
  "memorySize": 256,  // 256MB内存
  "timeout": 30       // 30秒超时
}
```

### API网关配置

#### 统一订单提交接口

```yaml
api:
  name: "pawsomeart-api"
  routes:
    - path: "/api/submit-order"
      method: "POST"
      backend:
        type: "function"
        function: "submit-order-unified"
      cors:
        allowOrigins: ["https://your-github-pages-domain.github.io"]
        allowMethods: ["POST", "OPTIONS"]
        allowHeaders: ["Content-Type"]
      requestConfig:
        maxBodySize: "50MB"  # 根据实际测试调整
        timeout: 300
    
    - path: "/api/recommendations"
      method: "POST"
      backend:
        type: "function"
        function: "recommendations"
      cors:
        allowOrigins: ["https://your-github-pages-domain.github.io"]
        allowMethods: ["POST", "OPTIONS"]
        allowHeaders: ["Content-Type"]
```

## 代码简化方案

### 需要删除的文件

#### 后端文件（完全删除）
```
api/
├── upload-batch.js           # 批量上传API - 删除
├── submit-order-batch.js     # 批量订单API - 删除
└── submit-order.js           # 传统订单API - 重构为云函数
```

#### 前端文件（简化重构）
```
src/utils/
├── batchUpload.js            # 批量上传逻辑 - 删除
├── uploadPrecheck.js         # 上传预检 - 简化
└── imageCompression.js       # 图片压缩 - 保留
```

### 新增云函数代码

#### 统一订单处理函数

```javascript
// volcengine-functions/submit-order-unified/index.js
import lark from '@larksuiteoapi/node-sdk';
import multiparty from 'multiparty';

// 初始化飞书客户端
const client = new lark.Client({
    appId: process.env.FEISHU_APP_ID,
    appSecret: process.env.FEISHU_APP_SECRET,
});

export const handler = async (event, context) => {
    const startTime = Date.now();
    
    try {
        console.log('开始处理统一订单提交请求');
        
        // 解析multipart/form-data
        const { fields, files } = await parseFormData(event);
        
        // 验证必要字段
        validateRequiredFields(fields);
        
        // 上传所有文件到飞书
        const fileTokens = await uploadAllFilesToLark(files);
        
        // 创建订单记录
        const orderId = await createOrderRecord(fields, fileTokens);
        
        const processingTime = Date.now() - startTime;
        
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify({
                success: true,
                orderId,
                processingTime,
                message: '订单提交成功'
            })
        };
        
    } catch (error) {
        console.error('订单处理失败:', error);
        
        return {
            statusCode: 500,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify({
                success: false,
                error: error.message,
                processingTime: Date.now() - startTime
            })
        };
    }
};

// 解析表单数据
async function parseFormData(event) {
    // 实现multipart/form-data解析逻辑
    // 支持大文件和多文件处理
}

// 上传所有文件到飞书
async function uploadAllFilesToLark(files) {
    const fileTokens = {
        user_uploads: [],
        uploadedImage: []
    };
    
    // 并发上传所有文件
    const uploadPromises = [];
    
    Object.keys(files).forEach(fieldName => {
        files[fieldName].forEach(file => {
            uploadPromises.push(
                uploadSingleFile(file).then(token => ({
                    fieldName,
                    token
                }))
            );
        });
    });
    
    const results = await Promise.all(uploadPromises);
    
    // 分类文件tokens
    results.forEach(({ fieldName, token }) => {
        if (fieldName === 'user_uploads') {
            fileTokens.user_uploads.push(token);
        } else if (fieldName === 'uploadedImage') {
            fileTokens.uploadedImage.push(token);
        }
    });
    
    return fileTokens;
}

// 上传单个文件
async function uploadSingleFile(file) {
    const response = await client.drive.media.uploadAll({
        data: {
            file_name: file.originalFilename,
            parent_type: 'bitable_file',
            parent_node: process.env.FEISHU_APP_TOKEN,
            size: file.size,
            file: file.buffer || fs.createReadStream(file.path),
        },
    });
    
    return response.data.file_token;
}

// 创建订单记录
async function createOrderRecord(fields, fileTokens) {
    const orderId = generateOrderId();
    
    const record = {
        "订单号": orderId,
        "手机号": fields.phone,
        "定制风格": fields.customization_style,
        "宠物照片": fileTokens.user_uploads,
        "参考图片": fileTokens.uploadedImage,
        // ... 其他字段
    };
    
    await client.bitable.appTableRecord.create({
        path: {
            app_token: process.env.FEISHU_APP_TOKEN,
            table_id: process.env.FEISHU_ORDERS_TABLE_ID,
        },
        data: {
            fields: record,
        },
    });
    
    return orderId;
}
```

### 前端简化代码

#### 简化的订单提交逻辑

```javascript
// src/utils/orderSubmission.js
export const submitOrder = async (formData) => {
    try {
        console.log('提交订单到火山引擎函数服务');
        
        const response = await fetch('/api/submit-order', {
            method: 'POST',
            body: formData, // 直接发送FormData，无需分批
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
            throw new Error(result.error || '订单提交失败');
        }
        
        return result;
        
    } catch (error) {
        console.error('订单提交失败:', error);
        throw error;
    }
};
```

#### 移除的复杂逻辑

```javascript
// 以下逻辑将被完全移除：

// 1. 批量上传策略选择
// shouldUseBatchUpload() - 删除
// groupFilesIntoBatches() - 删除
// executeBatchUpload() - 删除

// 2. 复杂的进度管理
// 多批次进度追踪 - 删除
// 批次失败重试 - 删除

// 3. 双重上传路径
// handleBatchUpload() - 删除
// handleTraditionalUpload() - 简化为单一路径
```

## 开发工作量对比

### 当前复杂架构工作量

| 组件 | 开发工作量 | 维护复杂度 |
|------|-----------|----------|
| 批量上传前端逻辑 | 5天 | 高 |
| 批量上传后端API | 4天 | 高 |
| 进度管理和错误处理 | 3天 | 高 |
| 测试覆盖 | 4天 | 高 |
| **总计** | **16天** | **高** |

### 简化架构工作量

| 组件 | 开发工作量 | 维护复杂度 |
|------|-----------|----------|
| 统一云函数开发 | 3天 | 低 |
| 前端简化逻辑 | 1天 | 低 |
| API网关配置 | 1天 | 低 |
| 测试覆盖 | 2天 | 低 |
| **总计** | **7天** | **低** |

### 工作量节省

- **开发时间节省**：9天 (56%减少)
- **维护复杂度**：从高降至低
- **代码行数减少**：预计减少60%+
- **测试用例减少**：预计减少50%+

## 实施计划

### 阶段1：技术验证 (2-3天)

1. **火山引擎环境搭建**
   - [ ] 开通veFaaS和API网关服务
   - [ ] 配置开发环境和权限
   - [ ] 创建测试函数验证文件上传限制

2. **文件上传限制测试**
   - [ ] 使用现有测试脚本验证实际限制
   - [ ] 测试不同文件大小和数量的处理能力
   - [ ] 确认技术可行性

### 阶段2：核心函数开发 (3-4天)

1. **统一订单处理函数**
   - [ ] 实现multipart/form-data解析
   - [ ] 集成飞书API调用
   - [ ] 实现错误处理和日志记录
   - [ ] 本地测试和调试

2. **推荐服务函数**
   - [ ] 迁移现有推荐逻辑
   - [ ] 优化响应性能
   - [ ] 测试验证

### 阶段3：API网关配置 (1天)

1. **网关配置**
   - [ ] 创建API网关实例
   - [ ] 配置路由和CORS
   - [ ] 设置请求限制和超时

2. **域名和SSL配置**
   - [ ] 配置自定义域名（可选）
   - [ ] 确保HTTPS访问

### 阶段4：前端适配 (2天)

1. **API调用层重构**
   - [ ] 更新API端点配置
   - [ ] 简化订单提交逻辑
   - [ ] 移除批量上传相关代码

2. **错误处理优化**
   - [ ] 适配新的错误响应格式
   - [ ] 简化用户提示逻辑

### 阶段5：测试和部署 (2天)

1. **集成测试**
   - [ ] 端到端功能测试
   - [ ] 性能基准测试
   - [ ] 错误场景测试

2. **生产部署**
   - [ ] 前端部署到GitHub Pages
   - [ ] 云函数部署到生产环境
   - [ ] 监控和告警配置

## 风险评估与缓解

### 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 文件大小限制不如预期 | 中 | 高 | 提前技术验证，保留降级方案 |
| 网络传输稳定性问题 | 低 | 中 | 增加重试机制，监控网络质量 |
| 飞书API集成问题 | 低 | 中 | 复用现有集成经验 |

### 业务风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 迁移期间服务中断 | 低 | 高 | 分阶段迁移，保持并行运行 |
| 用户体验变化 | 低 | 中 | 保持前端界面不变 |
| 成本增加 | 低 | 低 | 成本监控和预算控制 |

## 成本效益分析

### 开发成本

- **一次性开发成本**：7个工作日
- **迁移成本**：2个工作日
- **总投入**：9个工作日

### 长期收益

1. **维护成本降低**：预计每月节省2-3个工作日
2. **开发效率提升**：新功能开发速度提升50%
3. **系统稳定性提升**：减少复杂逻辑导致的bug
4. **用户体验改善**：更快的上传速度，更简单的流程

### ROI计算

- **投资回收期**：3-4个月
- **年度节省**：约30个工作日
- **ROI**：约300%

## 监控和运维

### 关键指标监控

1. **性能指标**
   - 函数执行时间
   - 文件上传成功率
   - API响应时间
   - 错误率

2. **业务指标**
   - 订单提交成功率
   - 用户满意度
   - 系统可用性

3. **成本指标**
   - 函数调用次数
   - 数据传输量
   - 月度费用

### 告警配置

```yaml
alerts:
  - name: "函数执行失败率过高"
    condition: "error_rate > 5%"
    action: "发送邮件和短信通知"
  
  - name: "响应时间过长"
    condition: "avg_response_time > 10s"
    action: "发送邮件通知"
  
  - name: "成本异常"
    condition: "daily_cost > threshold"
    action: "发送预算告警"
```

## 结论

基于火山引擎veFaaS的技术优势，本方案可以实现：

### 核心收益

1. **架构大幅简化**：从4个API函数减少到2个云函数
2. **开发工作量减少56%**：从16天减少到7天
3. **维护复杂度显著降低**：消除批量上传的复杂逻辑
4. **用户体验提升**：更快的上传速度，更简单的流程
5. **技术债务清理**：移除历史包袱，代码更清晰

### 技术优势

1. **突破文件大小限制**：从4.5MB提升到预期50MB+
2. **执行时间大幅提升**：从30秒提升到5分钟+
3. **弹性扩容能力**：自动应对流量峰值
4. **成本优化**：按实际使用量计费

### 实施建议

1. **立即启动技术验证**：确认火山引擎的实际能力
2. **分阶段实施**：降低迁移风险
3. **保持监控**：确保服务质量
4. **持续优化**：基于实际使用情况调整配置

通过采用火山引擎veFaaS，PawsomeArt项目将获得更简洁、更高效、更易维护的技术架构，为未来的业务发展奠定坚实的技术基础。

---

**文档版本**：v1.0  
**创建日期**：2024年1月31日  
**负责人**：开发团队  
**状态**：待技术验证