# PawsomeArt 开发修改日志

本文档记录了 PawsomeArt 项目的开发过程中的重要修改和优化。

## 2025年开发记录

### 飞书多维表格容量管理策略制定

#### 背景
- **问题识别**: 随着业务增长，飞书多维表格面临容量限制问题（~~最大50,000行~~ **更新**：个人版账号最大20,000行）
- **风险评估**: 达到容量上限时，新增订单记录会报错，影响线上业务连续性
- **紧急性**: 需要提前规划，避免业务中断
- **容量配置调整**（个人版2万行限制）：
  - 预警阈值：16,000行（80%）
  - 严重预警阈值：18,000行（90%）
  - 最大容量：20,000行

#### 解决方案
1. **方案一：归档表策略（短期实施）**
   - 利用飞书归档表功能，支持100万行数据存储
   - 定期将历史订单归档，保持主表数据量在安全范围内
   - 实施周期：4-6周

2. **方案三：混合数据库架构（长期规划）**
   - 引入专业数据库（PostgreSQL/MySQL）作为主要存储
   - 保留飞书多维表格用于团队协作和数据展示
   - 实现数据双写和智能同步机制
   - 实施周期：6-12个月

#### 创建的文档
- **容量管理计划**: `prd_and_plan/feishu_capacity_management_plan.md`
  - 详细的实施步骤和时间规划
  - 技术架构设计和风险评估
  - 成功指标和监控方案
- **README更新**: 添加了容量管理文档的引用

#### 下一步行动
- [ ] 联系飞书客服申请归档表功能
- [ ] 在代码中添加容量监控逻辑
- [ ] 创建备用多维表格作为应急方案
- **状态**: 📋 计划制定完成，等待实施

### 界面文案优化与技术问题修复

#### 修复的技术问题

1. **上传图片按钮点击区域错位问题**
   - **问题描述**: 在 `SceneArtworkStep.jsx` 中，上传图片按钮的点击区域与视觉显示不匹配
   - **解决方案**: 
     - 为上传区域的父 `div` 添加 `relative` 类
     - 为 `input` 元素添加 `z-10` 层级
   - **修改文件**: `src/pages/Customization/SceneArtworkStep.jsx`
   - **状态**: ✅ 已完成

2. **订单提交失败错误**
   - **问题描述**: 前端 Vite 配置中 API 代理指向 `localhost:3001`，但后端服务器未运行
   - **解决方案**: 启动后端 API 服务器 (`npm run dev:api`)
   - **验证**: 通过 curl 测试确认 API 正常工作，成功创建订单记录
   - **状态**: ✅ 已完成

#### 界面文案优化

3. **名作致敬款文字描述功能优化**
   - **需求**: 针对"名作致敬款"(product.id === 2)，修改文字描述相关的按钮和输入框文案，使其更符合宠物肖像画艺术形象的描述
   - **保持不变**: "经典定制款"和"姿态保留款"的文案保持原样
   - **实现方案**: 
     - 利用现有的 `isArtworkProduct` 判断逻辑进行条件渲染
     - 修改文字描述按钮的副标题
     - 修改 textarea 输入框的标题和 placeholder 文案
     - 修改帮助提示文字
   - **具体修改内容**:
     - 按钮副标题: "用文字描述您的想法" → "描述您宠物的特征和期望的艺术风格"
     - 输入框标题: "请描述您期望的名画风格" (名作致敬款) / "请描述您期望的场景背景" (其他款式)
     - Placeholder: "例如：希望模仿梵高的星夜风格..." (名作致敬款) / "例如：希望在樱花飞舞的公园里..." (其他款式)
     - 帮助文字: "详细的描述能帮助我们更好地理解您的艺术需求" (名作致敬款) / "详细的描述能帮助我们更好地还原您想要的场景" (其他款式)
   - **修改文件**: `src/pages/Customization/SceneArtworkStep.jsx`
   - **状态**: ✅ 已完成

#### 质量保证

- **测试验证**: 所有修改都经过了功能测试，确保:
  - 上传按钮点击正常
  - 订单提交流程完整
  - 不同产品类型显示正确的文案
  - 开发服务器运行稳定，无错误

#### 技术实现亮点

- **条件渲染**: 使用 React 的条件渲染机制，根据产品类型动态显示不同文案
- **分离式修改**: 针对特定产品类型进行精确修改，不影响其他功能
- **热更新**: 利用 Vite 的 HMR 功能，实现实时预览修改效果

#### 最终成果

项目现在具备了完整的用户体验流程，特别是名画致敬款的宠物特征描述功能，为用户提供了更加直观和专业的定制体验。所有技术问题已解决，界面文案已优化，系统运行稳定。

---

#### 开发日志系统搭建

- **时间**: 2025-08-23 13:39:26
- **描述**: 创建了完整的开发日志管理系统，包括日志文件、管理脚本和相关文档
- **修改文件**: prd_and_plan/development_changelog.md, scripts/add-changelog-entry.cjs, README.md, package.json
- **状态**: ✅ 已完成

### API 安全防护功能实施

#### 请求频率限制系统

4. **API 频率限制中间件集成**
   - **需求背景**: 防止机器人大量提交订单导致飞书多维表格崩溃，以及批量爬取图片素材等恶意行为
   - **技术方案**: 使用 `express-rate-limit` 中间件实现多层次频率限制
   - **实现内容**:
     - **通用 API 限制**: 所有 `/api` 路由每个 IP 在 15 分钟内最多 100 次请求
     - **订单提交专用限制**: `/api/submit-order` 每个 IP 每分钟最多 3 次提交
     - **增强手机号验证**: 添加严格的中国大陆手机号正则验证 `/^1[3-9]\d{9}$/`
     - **详细日志记录**: 频率限制触发时记录 IP 地址和时间戳
   - **修改文件**: 
     - `server.cjs`: 添加频率限制中间件配置
     - `api/submit-order.js`: 增强手机号验证逻辑
     - `package.json`: 添加 express-rate-limit 依赖
   - **测试验证**: 
     - ✅ 通用频率限制正常工作
     - ✅ 订单提交频率限制有效拦截（前3次正常，第4、5次返回429状态码）
     - ✅ 服务器日志正确记录频率限制触发事件
     - ✅ 手机号格式验证功能正常
   - **安全效果**:
     - 有效防止机器人自动化攻击
     - 控制 API 滥用和服务器过载
     - 过滤无效手机号数据
     - 提供实时攻击监控能力
   - **状态**: ✅ 已完成
   - **时间**: 2025-08-23 14:03:35


### 成功提交页面视觉优化

#### 背景
- **用户反馈**: 成功提交页面存在多个视觉问题需要优化
- **具体问题**: 
  1. 大块绿色背景不够美观
  2. "1 天内"文案需要修改为"1-2 天内"
  3. "返回首页"按钮样式不符合整体视觉调性
  4. 标题字体需要改为宋体以符合项目整体风格

#### 解决方案

5. **成功提交页面视觉优化**
   - **绿色背景优化**: 将原有的渐变绿色背景 `bg-gradient-to-r from-green-400 to-green-500` 改为更清淡的 `bg-green-50 border-b border-green-100`
   - **文字颜色调整**: 将白色文字 `text-white` 改为更协调的 `text-green-700`
   - **文案内容修改**: 将"1 天内"修改为"1-2 天内"，更准确反映实际处理时间
   - **按钮样式统一**: 将"返回首页"按钮从渐变样式改为项目统一的棕色调 `bg-[#D2B48C]`
   - **字体风格统一**: 为h1和h2标题添加 `font-song` 类名，使用项目配置的宋体字体族
   - **修改文件**: `src/pages/SubmissionSuccess/index.jsx`
   - **技术实现**: 
     - 利用Tailwind CSS的全局字体配置 `font-song`
     - 保持响应式设计和用户体验一致性
     - 通过Vite热更新实现实时预览效果
   - **测试验证**: 
     - ✅ 视觉效果优化符合预期
     - ✅ 字体显示正常（SimSun、STSong等宋体）
     - ✅ 前端服务器运行稳定
     - ✅ 页面功能完整性保持不变
   - **状态**: ✅ 已完成
   - **时间**: 2025-01-25

#### 技术实现亮点

- **全局字体配置**: 使用项目在 `tailwind.config.cjs` 中预配置的宋体字体族，确保跨平台兼容性
- **视觉层次优化**: 通过颜色和背景的调整，提升页面的视觉层次和用户体验
- **品牌一致性**: 按钮颜色统一使用项目主色调，保持整体视觉风格的一致性
- **实时开发**: 利用Vite的HMR功能，实现修改后的即时预览和验证

#### 最终效果

成功提交页面现在具有更加协调的视觉效果，绿色背景更加清淡优雅，文字内容更加准确，按钮样式与整体设计保持一致，标题使用宋体字体提升了页面的文化气质和专业感。

---

## 开发环境信息

- **前端服务器**: http://localhost:5173 (Vite)
- **后端API服务器**: http://localhost:3001
- **主要技术栈**: React + Vite + Tailwind CSS + Node.js
- **开发工具**: Trae AI IDE

### 多宠物照片上传功能升级

#### 背景
- **需求变更**: 用户希望经典定制款支持更多宠物数量的画像定制
- **原有限制**: 经典定制款最多支持3只宠物，每只宠物需要3张照片
- **目标**: 扩展经典定制款支持更多宠物，提升用户选择灵活性

#### 开发过程

**第一阶段：系统容量评估**
- **后端分析**: 检查 `api/submit-order.js` 的文件处理能力
  - multer配置支持最多20个文件上传
  - 单文件大小限制10MB，总体处理能力充足
- **前端分析**: 验证 `PhotoUploadStep.jsx` 组件的扩展性
  - 照片数量计算逻辑基于宠物数量动态调整
  - UI界面支持大量照片展示和交互

**第二阶段：功能扩展实现**
- **价格矩阵更新**: 修改 `BasicInfoStep.jsx` 中的 `PRICE_MATRIX`
  - 为经典定制款（ID为1）添加4只和5只宠物的价格配置
  - 4只宠物：1580元（大尺寸）
  - 5只宠物：1780元（大尺寸）
- **UI界面调整**: 
  - 宠物数量选择从3个选项扩展到5个选项
  - 网格布局从3列调整为5列
  - 价格计算逻辑支持具体宠物数量而非"3+"通用键
- **照片上传逻辑**: 
  - 自动支持最多15张照片（5只宠物×3张）
  - 保持原有的文件验证和错误处理机制

**第三阶段：功能测试验证**
- **创建测试脚本**: `test-5-pets-upload.cjs`
  - 模拟5只宠物15张照片的完整上传流程
  - 验证订单提交和文件处理功能
  - 测试结果：成功（订单号：PA-20250823-8000-1J7DXZ）

**第四阶段：需求调整**
- **用户反馈**: 认为5只宠物过多，希望限制在4只以内
- **功能回调**: 
  - 移除5只宠物选项和相关价格配置
  - UI调整为4列网格布局
  - 最大照片数量调整为12张（4只宠物×3张）
- **最终测试**: 验证4只宠物12张照片上传功能正常

#### 技术实现亮点

1. **差异化定价策略**
   - 经典定制款使用具体宠物数量进行价格计算
   - 其他产品保持原有的"3+"逻辑不变
   - 确保向下兼容性

2. **智能照片验证**
   - 基于产品类型和宠物数量动态计算所需照片数
   - 自动调整上传限制和验证规则
   - 保持用户体验的一致性

3. **性能优化考虑**
   - 后端multer配置预留充足的文件处理能力
   - 前端组件设计支持大量照片的流畅交互
   - 文件大小和类型验证确保系统稳定性

#### 最终配置

- **经典定制款宠物数量**: 1-4只
- **价格范围**: 328元（1只宠物8寸）- 1580元（4只宠物大尺寸）
- **最大照片数量**: 12张（4只宠物×3张）
- **其他产品**: 保持原有配置不变

#### 修改的文件

- `src/pages/Customization/components/BasicInfoStep.jsx`
  - 更新价格矩阵和UI选项
  - 优化价格计算和尺寸选择逻辑
- `src/pages/Customization/components/PhotoUploadStep.jsx`
  - 照片数量计算逻辑自动适应新配置

#### 状态
- ✅ **已完成**: 多宠物照片上传功能升级
- ✅ **已测试**: 4只宠物12张照片上传流程验证通过
- 📋 **待优化**: 文件上传性能优化（如需要）

## 备注

本日志将持续更新，记录项目的重要修改和优化过程。