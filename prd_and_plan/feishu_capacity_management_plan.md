# 飞书多维表格容量管理计划

## 项目背景

当前项目使用飞书多维表格存储订单数据，随着业务增长，面临容量限制问题：
- 当前使用的飞书版本容量限制：最大20,000行（个人版）
- 达到容量上限时，新增记录会报错，影响线上业务
- 需要制定容量管理策略确保业务连续性

## 当前状态

- **飞书配置**：
  - APP_ID: `cli_a82b11b2cef8500b`
  - 订单表ID: `tbl2H2OYtBX0TLbT`
  - API集成：使用 `@larksuiteoapi/node-sdk`

- **数据存储**：
  - 主要通过 `api/submit-order.js` 的 `createBitableRecord` 函数写入数据
  - 包含用户订单、图片上传、产品配置等信息

## 方案一：归档表策略（当前实施）

### 目标
- 利用飞书归档表功能，支持100万行数据存储
- 定期将历史订单归档，保持主表数据量在安全范围内
- 确保归档数据仍可查询和统计

### 实施步骤

#### 第一阶段：准备工作（1-2周）
1. **联系飞书客服**
   - 申请开通归档表功能
   - 确认当前版本支持扩容至50,000行

2. **监控系统建设**
   - ✅ **已完成**：在 `api/submit-order.js` 中添加记录数量检查
   - ✅ **已完成**：设置容量预警机制（如达到80%时发送通知，16,000行预警）
   - ✅ **已完成**：创建数据量监控仪表盘（`scripts/capacity-monitor.js`）

3. **备用表格准备**
   - ✅ **已完成**：创建备用多维表格作为应急方案
   - ✅ **已完成**：配置相同的字段结构
   - ✅ **已完成**：在环境变量中添加备用表格配置

#### 第二阶段：归档功能开发（2-3周）
1. **归档逻辑设计**
   - [ ] 定义归档规则（如：30天前的已完成订单）
   - [ ] 设计归档触发条件（定时任务 + 容量阈值）
   - [ ] 实现归档状态标记

2. **代码实现**
   - [ ] 创建归档管理模块 `scripts/archive-manager.js`
   - [ ] 实现自动归档功能
   - [ ] 添加归档数据查询接口
   - [ ] 更新数据统计逻辑（包含归档数据）

3. **测试验证**
   - [ ] 单元测试：归档逻辑测试
   - [ ] 集成测试：归档后数据完整性验证
   - [ ] 性能测试：大量数据归档性能

#### 第三阶段：上线部署（1周）
1. **部署准备**
   - [ ] 生产环境归档表配置
   - [ ] 监控告警配置
   - [ ] 回滚方案准备

2. **灰度发布**
   - [ ] 小批量数据归档测试
   - [ ] 监控系统稳定性
   - [ ] 全量启用归档功能

### 技术实现要点

```javascript
// 容量检查示例
const checkTableCapacity = async (tableId) => {
  const response = await client.bitable.appTableRecord.list({
    path: {
      app_token: process.env.FEISHU_APP_TOKEN,
      table_id: tableId,
    },
    params: {
      page_size: 1,
    },
  });
  
  const totalRecords = response.data.total;
  const capacityLimit = 18000; // 设置为90%阈值（个人版20000行的90%）
  
  if (totalRecords >= capacityLimit) {
    // 触发归档或切换到备用表格
    await triggerArchiveProcess();
  }
};
```

## 方案三：混合数据库架构（长期规划）

### 目标
- 构建可扩展的数据存储架构
- 保留飞书多维表格的协作优势
- 支持大规模数据存储和高性能查询

### 架构设计

#### 数据分层策略
1. **飞书多维表格层**
   - 存储：近期订单（最近30天）
   - 用途：团队协作、数据展示、业务分析
   - 容量：控制在10,000条以内

2. **专业数据库层**
   - 技术选型：PostgreSQL（推荐）或 MySQL
   - 存储：全量历史数据
   - 用途：数据备份、复杂查询、报表生成

3. **缓存层**
   - 技术选型：Redis
   - 用途：热点数据缓存、会话管理

#### 数据同步机制
1. **实时同步**
   - 新订单同时写入飞书表格和数据库
   - 使用事务确保数据一致性

2. **定期同步**
   - 每日将数据库中的关键数据同步到飞书
   - 定期清理飞书表格中的历史数据

### 开发计划

#### 第一阶段：基础设施搭建（4-6周）
1. **数据库设计**
   - [ ] 设计订单表结构
   - [ ] 创建索引优化查询性能
   - [ ] 设计数据迁移方案

2. **环境配置**
   - [ ] 选择数据库托管服务（如 Supabase、PlanetScale）
   - [ ] 配置数据库连接
   - [ ] 设置环境变量

3. **ORM集成**
   - [ ] 选择ORM框架（如 Prisma、Sequelize）
   - [ ] 创建数据模型
   - [ ] 实现基础CRUD操作

#### 第二阶段：数据层重构（6-8周）
1. **数据访问层**
   - [ ] 创建统一的数据访问接口
   - [ ] 实现双写机制（飞书+数据库）
   - [ ] 添加数据一致性检查

2. **API重构**
   - [ ] 重构 `api/submit-order.js`
   - [ ] 添加数据库写入逻辑
   - [ ] 实现错误处理和回滚

3. **查询优化**
   - [ ] 实现智能数据源选择
   - [ ] 添加缓存层
   - [ ] 优化复杂查询性能

#### 第三阶段：数据迁移（2-3周）
1. **历史数据迁移**
   - [ ] 从飞书导出历史数据
   - [ ] 数据清洗和格式转换
   - [ ] 批量导入数据库

2. **数据验证**
   - [ ] 数据完整性检查
   - [ ] 业务逻辑验证
   - [ ] 性能基准测试

#### 第四阶段：监控和优化（持续）
1. **监控系统**
   - [ ] 数据库性能监控
   - [ ] 数据同步状态监控
   - [ ] 业务指标监控

2. **持续优化**
   - [ ] 查询性能优化
   - [ ] 存储成本优化
   - [ ] 备份策略完善

### 技术栈选择

#### 数据库选项
1. **PostgreSQL + Supabase**
   - 优势：功能强大、JSON支持、实时订阅
   - 适用：复杂查询、实时数据需求

2. **MySQL + PlanetScale**
   - 优势：成熟稳定、分支管理、无服务器
   - 适用：传统关系型数据需求

#### ORM选择
1. **Prisma**
   - 优势：类型安全、迁移管理、查询构建器
   - 推荐用于TypeScript项目

2. **Sequelize**
   - 优势：成熟稳定、多数据库支持
   - 适用于JavaScript项目

## 风险评估与应对

### 技术风险
1. **数据一致性风险**
   - 风险：双写过程中可能出现数据不一致
   - 应对：实现事务机制、定期数据校验

2. **性能风险**
   - 风险：双写可能影响响应时间
   - 应对：异步写入、缓存优化

3. **迁移风险**
   - 风险：数据迁移过程中可能丢失数据
   - 应对：分批迁移、完整备份、回滚方案

### 业务风险
1. **服务中断风险**
   - 风险：系统升级过程中可能影响业务
   - 应对：灰度发布、蓝绿部署

2. **成本风险**
   - 风险：数据库服务增加运营成本
   - 应对：成本预算、使用量监控

## 时间规划

### 短期（1-2个月）
- 完成方案一的实施
- 建立容量监控和预警机制
- 开始方案三的技术调研

### 中期（3-6个月）
- 完成混合架构的基础设施搭建
- 实现数据双写机制
- 开始历史数据迁移

### 长期（6-12个月）
- 完成全面的混合架构部署
- 优化系统性能和成本
- 建立完善的监控和运维体系

## 成功指标

### 方案一成功指标
- [ ] 归档功能正常运行，历史数据成功归档
- [ ] 主表数据量控制在安全范围内（<16,000行）
- [ ] 系统稳定性：99.9%可用性
- [ ] 数据完整性：0数据丢失

### 方案三成功指标
- [ ] 数据库性能：查询响应时间<100ms
- [ ] 数据一致性：飞书与数据库数据一致性>99.9%
- [ ] 系统扩展性：支持100万+订单数据
- [ ] 成本控制：月度数据库成本<$100

## 下一步行动

### 立即执行（本周）
1. [ ] 联系飞书客服申请归档表功能
2. ✅ **已完成**：在代码中添加容量监控逻辑
3. ✅ **已完成**：创建备用多维表格

### 近期执行（2周内）
1. [ ] 完成归档功能的详细设计
2. [ ] 开始数据库技术选型调研
3. [ ] 制定详细的开发时间表

## 已创建的工具和配置

### 环境配置文件更新
**文件**: `.env.local`

已添加以下配置项：
```bash
# 飞书多维表格配置
FEISHU_APP_ID=cli_a82b11b2cef8500b
FEISHU_APP_SECRET=rwvdNRqdGK5jniJZ5qnaDrB1vpOrapT0
FEISHU_APP_TOKEN=D57IbyuasaNE0qsqVEmcTBHJnNf

# 主订单表
FEISHU_ORDERS_TABLE_ID=tbl2H2OYtBX0TLbT

# 备用表格配置（容量管理策略）
# FEISHU_BACKUP_APP_TOKEN=
# FEISHU_BACKUP_ORDERS_TABLE_ID=

# 容量管理配置（个人版20000行限制）
# FEISHU_CAPACITY_WARNING_THRESHOLD=16000
# FEISHU_CAPACITY_MAX_THRESHOLD=18000
```

### 容量监控脚本
**文件**: `scripts/capacity-monitor.js`

**功能特性**：
- 实时检查表格记录数量
- 容量预警通知（16000条预警，18000条严重预警）
- 自动触发归档流程
- 备用表格切换机制
- 容量使用报告生成

**使用方法**：
```bash
# 执行容量监控
npm run capacity:monitor

# 生成容量报告
npm run capacity:report

# 快速检查当前容量
npm run capacity:check
```

### NPM脚本命令
**文件**: `package.json`

已添加以下脚本命令：
- `capacity:monitor` - 执行完整的容量监控流程
- `capacity:report` - 生成详细的容量使用报告
- `capacity:check` - 快速检查当前记录数和使用率

### 待实现功能

容量监控脚本中标记为 `TODO` 的功能：
1. **通知系统集成**
   - 邮件通知
   - 飞书消息通知
   - 企业微信/钉钉通知

2. **归档流程实现**
   - 查询需要归档的记录（如30天前的已完成订单）
   - 将记录移动到归档表
   - 验证归档成功
   - 删除主表中的已归档记录

3. **备用表格切换**
   - 自动更新环境变量或配置文件
   - 应用服务重启机制
   - 新表格可用性验证

## 总结

通过实施上述容量管理策略，可以有效解决飞书多维表格的容量限制问题：

1. **短期**：归档表策略提供100万行的扩展容量
2. **中期**：多表轮换确保业务连续性
3. **长期**：混合架构提供无限扩展能力

**当前进展**：
- ✅ 环境配置已完成
- ✅ 容量监控工具已创建
- ✅ 基础架构已搭建
- 🔄 归档功能开发中
- 📋 混合架构规划中

建议优先实施方案一（归档表策略），同时为方案三（混合架构）做好技术准备，确保项目能够平稳应对数据增长挑战。

---

**文档维护**
- 创建时间：2024年12月
- 负责人：开发团队
- 更新频率：每周更新进度
- 下次评审：2周后