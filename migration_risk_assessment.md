# PawsomeArt 项目迁移风险评估与检测清单

> **创建时间**: 2024年
> **项目**: PawsomeArt 宠物艺术定制平台
> **迁移目标**: Vercel → 火山引擎 veFaaS + GitHub Pages

## 📋 迁移前检查清单

### ✅ 环境准备
- [ ] 火山引擎账号注册和实名认证
- [ ] 开通函数服务 (veFaaS) 和 API 网关服务
- [ ] 配置访问密钥 (AK/SK)
- [ ] 安装 veFaaS Code Deployer 插件
- [ ] 备份当前 Vercel 环境变量
- [ ] 创建 GitHub 仓库（如需要）
- [ ] 配置 GitHub Pages 设置

### ✅ 代码准备
- [ ] 创建新的开发分支
- [ ] 备份当前工作代码
- [ ] 确保所有测试通过
- [ ] 记录当前 API 端点和功能

## 🚨 高风险区域监控

### 1. API调用架构变更

**风险等级**: 🔴 极高

**风险描述**:
- 前端API调用从相对路径 `/api/*` 改为绝对路径
- 可能导致CORS跨域问题
- 所有API功能可能失效

**影响范围**:
- 订单提交功能
- 文件上传功能
- 推荐数据获取
- 批量处理功能

**检测方法**:
```bash
# 检查前端API调用
grep -r "fetch('/api" src/
grep -r "axios.post('/api" src/
```

**规避策略**:
- [ ] 使用环境变量区分开发和生产环境
- [ ] 先在本地环境完整测试新的API调用方式
- [ ] 保持原Vercel服务运行，实现蓝绿部署
- [ ] 配置详细的CORS策略

**回滚计划**:
- [ ] 准备快速切换DNS或代理配置
- [ ] 保留原API调用代码的备份分支

---

### 2. 文件上传机制重构

**风险等级**: 🔴 极高

**风险描述**:
- multipart/form-data处理方式变化
- 火山引擎函数的文件处理限制
- 可能破坏核心文件上传功能

**影响范围**:
- 用户无法上传宠物照片
- 批量文件上传失效
- 核心业务功能中断

**检测方法**:
```bash
# 测试文件上传功能
curl -X POST -F "file=@test.jpg" http://localhost:3001/api/upload-batch
```

**规避策略**:
- [ ] 先创建独立的文件上传测试函数
- [ ] 使用相同的multiparty库保持兼容性
- [ ] 测试各种文件格式和大小
- [ ] 实现文件大小和类型验证
- [ ] 准备分片上传方案（如需要）

**测试清单**:
- [ ] 单文件上传 (< 1MB)
- [ ] 大文件上传 (> 5MB)
- [ ] 多文件批量上传
- [ ] 不同格式文件 (JPG, PNG, HEIC)
- [ ] 错误文件格式处理

---

### 3. 环境变量和配置迁移

**风险等级**: 🔴 极高

**风险描述**:
- 飞书API密钥等敏感配置可能丢失
- 环境变量名称不一致
- 配置格式差异

**影响范围**:
- 数据无法写入飞书表格
- 订单系统完全失效
- 用户数据丢失

**当前环境变量清单**:
```
FEISHU_APP_ID=xxx
FEISHU_APP_SECRET=xxx
FEISHU_APP_TOKEN=xxx
FEISHU_ORDERS_TABLE_ID=xxx
FEISHU_BATCH_TABLE_ID=xxx
MOCK_FEISHU=false
```

**检测方法**:
```bash
# 验证环境变量
node -e "console.log(process.env.FEISHU_APP_TOKEN ? '✅ 配置正确' : '❌ 配置缺失')"
```

**规避策略**:
- [ ] 提前备份所有环境变量到安全位置
- [ ] 在火山引擎测试环境先验证配置
- [ ] 使用相同的变量名保持一致性
- [ ] 创建配置验证脚本

---

## ⚠️ 中等风险区域监控

### 4. 前后端分离部署

**风险等级**: 🟡 中等

**风险描述**:
- GitHub Pages静态部署的SPA路由问题
- 页面刷新可能出现404错误
- 深层链接访问失败

**检测方法**:
- [ ] 测试所有路由路径直接访问
- [ ] 测试页面刷新功能
- [ ] 测试浏览器前进后退

**规避策略**:
- [ ] 配置GitHub Pages的SPA重定向规则
- [ ] 添加404.html fallback页面
- [ ] 测试所有路由路径

---

### 5. 函数冷启动延迟

**风险等级**: 🟡 中等

**风险描述**:
- 首次API调用可能超时
- 用户体验下降
- 可能误以为系统故障

**检测方法**:
```bash
# 测试冷启动时间
time curl -X GET https://your-api.com/api/health
```

**规避策略**:
- [ ] 实现函数预热机制
- [ ] 添加加载状态提示
- [ ] 设置合理的超时时间（30秒）
- [ ] 监控函数响应时间

---

### 6. 跨域配置复杂性

**风险等级**: 🟡 中等

**风险描述**:
- CORS策略配置不当
- 不同浏览器兼容性问题
- 预检请求失败

**检测方法**:
```javascript
// 浏览器控制台测试
fetch('https://your-api.com/api/health', {
  method: 'GET',
  headers: { 'Content-Type': 'application/json' }
}).then(r => console.log('✅ CORS正常')).catch(e => console.log('❌ CORS错误', e))
```

**规避策略**:
- [ ] 详细配置API网关的CORS策略
- [ ] 测试不同浏览器的兼容性
- [ ] 准备备用的代理方案

---

## 🔧 分阶段迁移计划

### 阶段1: 只读功能迁移 (低风险)
- [ ] 迁移 `/api/recommendations` 端点
- [ ] 测试推荐数据获取功能
- [ ] 验证前端显示正常

### 阶段2: 文件上传功能迁移 (高风险)
- [ ] 迁移 `/api/upload-batch` 端点
- [ ] 测试文件上传功能
- [ ] 验证文件处理和存储

### 阶段3: 订单提交功能迁移 (极高风险)
- [ ] 迁移 `/api/submit-order` 端点
- [ ] 迁移 `/api/submit-order-batch` 端点
- [ ] 测试飞书数据写入
- [ ] 验证完整订单流程

### 阶段4: 完整切换
- [ ] 更新DNS或代理配置
- [ ] 关闭原Vercel服务
- [ ] 监控系统稳定性

---

## 📊 监控和告警设置

### 关键指标监控
- [ ] API调用成功率 (目标: >99%)
- [ ] 函数执行时间 (目标: <5秒)
- [ ] 文件上传成功率 (目标: >95%)
- [ ] 飞书数据写入成功率 (目标: >99%)

### 告警配置
- [ ] API错误率超过5%时告警
- [ ] 函数执行时间超过10秒时告警
- [ ] 连续5次调用失败时告警

---

## 🚨 紧急回滚程序

### 触发条件
- API成功率低于90%
- 核心功能无法使用超过5分钟
- 数据写入失败率超过10%

### 回滚步骤
1. [ ] 立即切换DNS回原Vercel服务
2. [ ] 恢复原前端代码部署
3. [ ] 验证原服务功能正常
4. [ ] 通知用户服务已恢复
5. [ ] 分析失败原因

### 回滚验证
- [ ] 测试订单提交功能
- [ ] 测试文件上传功能
- [ ] 测试推荐数据获取
- [ ] 验证飞书数据写入

---

## 📝 测试检查清单

### 功能测试
- [ ] 用户注册和登录
- [ ] 产品浏览和选择
- [ ] 文件上传（单个/批量）
- [ ] 订单信息填写
- [ ] 订单提交和确认
- [ ] 推荐数据显示
- [ ] 错误处理和提示

### 性能测试
- [ ] 页面加载时间 (<3秒)
- [ ] API响应时间 (<2秒)
- [ ] 文件上传速度
- [ ] 并发用户测试 (10个用户)

### 兼容性测试
- [ ] Chrome浏览器
- [ ] Safari浏览器
- [ ] Firefox浏览器
- [ ] 移动端浏览器
- [ ] 不同屏幕尺寸

### 安全测试
- [ ] HTTPS证书验证
- [ ] API访问权限
- [ ] 文件上传安全性
- [ ] 敏感数据保护

---

## 📞 应急联系信息

### 技术支持
- 火山引擎技术支持: [联系方式]
- GitHub技术支持: [联系方式]

### 内部联系人
- 项目负责人: [姓名和联系方式]
- 技术负责人: [姓名和联系方式]
- 运维负责人: [姓名和联系方式]

---

## 📅 迁移时间表

| 阶段 | 时间 | 主要任务 | 风险等级 |
|------|------|----------|----------|
| 准备阶段 | 第1周 | 环境搭建、代码备份 | 🟢 低 |
| 阶段1 | 第2周 | 推荐功能迁移 | 🟡 中 |
| 阶段2 | 第3周 | 文件上传迁移 | 🔴 高 |
| 阶段3 | 第4周 | 订单功能迁移 | 🔴 极高 |
| 阶段4 | 第5周 | 完整切换和优化 | 🟡 中 |

---

## 📋 每日检查清单

### 迁移期间每日必检
- [ ] 检查原服务运行状态
- [ ] 检查新服务部署状态
- [ ] 验证关键功能正常
- [ ] 查看错误日志
- [ ] 检查监控指标
- [ ] 备份重要数据

### 迁移完成后每日必检
- [ ] API调用成功率
- [ ] 函数执行状态
- [ ] 用户反馈收集
- [ ] 系统性能指标
- [ ] 安全状态检查

---

**⚠️ 重要提醒**: 
1. 每个阶段完成后必须进行完整的功能测试
2. 发现任何异常立即停止迁移并分析原因
3. 保持原服务运行直到新服务完全稳定
4. 定期备份重要数据和配置
5. 及时更新本文档的检查状态

**📱 快速检查命令**:
```bash
# 检查服务状态
curl -s https://your-api.com/api/health | jq '.ok'

# 检查函数日志
# 在火山引擎控制台查看

# 检查前端部署
curl -s https://your-frontend.github.io/ | grep "PawsomeArt"
```